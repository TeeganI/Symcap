---
title: "Color Analysis"
author: "Teegan Innis"
date: "January 23, 2017"
output: html_document
---
# Library Packages
```{r Library Packages Needed, warning=FALSE, message=FALSE}
setwd("~/Symcap")
library(data.table)
library(lsmeans)
library(devtools)
library(plyr)
library(reshape2)
library(popbio)
library(RgoogleMaps)
library(plotrix)
library(zoo)
library(rgdal)
library(car)
library(scales)
library(png)
library(pixmap)
library(ecodist)
library(cluster)
library(fpc)
library(clustsig)
library(mapplots)
library(foreign)
library(nnet)
library(ggplot2)
library(mlogit)
```


# Import/Merge Collection and qPCR Data
```{r Import Data, warning=FALSE, message=FALSE}
Coral_Data <- read.csv("Data/Collection Data/Coral_Collection.csv")
Coral_Data$Depth..m. <- as.numeric(as.character(Coral_Data$Depth..m.))
source_url("https://raw.githubusercontent.com/jrcunning/steponeR/master/steponeR.R")
Mcap.plates <- list.files(path = "Data/qPCR_data", pattern = "txt$", full.names = T)
Mcap <- steponeR(files = Mcap.plates, delim="\t",
                 target.ratios=c("C.D"), 
                 fluor.norm = list(C=2.26827, D=0), 
                 copy.number=list(C=33, D=3))
Mcap <- Mcap$result
Mcap <- Mcap[grep("+", Mcap$Sample.Name, fixed=T, invert = T), ]
Mcap <- Mcap[grep("NTC", Mcap$Sample.Name, fixed = T, invert = T), ]
Mcap <- Mcap[grep("PCT", Mcap$Sample.Name, fixed = T, invert = T), ]
colnames(Mcap)[which(colnames(Mcap)=="Sample.Name")] <- "Colony"
Mcap$fail <- ifelse(Mcap$C.reps < 2 & Mcap$D.reps < 2, TRUE, FALSE)
fails <- Mcap[Mcap$fail==TRUE, ]
Mcap <- Mcap[which(Mcap$fail==FALSE),]
Mcap$C.D[which(Mcap$C.reps<2)] <- -Inf
Mcap$C.D[which(Mcap$D.reps<2)] <- Inf
Mcap <- Mcap[with(Mcap, order(Colony)), ]
Mcap$propC <- Mcap$C.D / (Mcap$C.D+1)
Mcap$propD <- 1-Mcap$propC
Mcap$propD[which(Mcap$C.D==-Inf)] <-1
Mcap$propC[which(Mcap$C.D==-Inf)] <-0
Mcap$propD[which(Mcap$C.D==Inf)] <-0
Mcap$propC[which(Mcap$C.D==Inf)] <-1
Mcap$Dom <- ifelse(Mcap$propC>Mcap$propD, "C", "D")
Symcap<-merge(Coral_Data, Mcap, by="Colony", all=T)
Symcap <- Symcap[with(Symcap, order(Colony)), ]
Symcap$Mix <- factor(ifelse(Symcap$propC>Symcap$propD, ifelse(Symcap$propD!=0, "CD", "C"), ifelse(Symcap$propD>Symcap$propC, ifelse(Symcap$propC!=0, "DC", "D"), NA)), levels = c("C", "CD", "DC", "D"))
Symcap$Reef.Area <- ifelse(Symcap$Reef.Area!="Top", yes = "Slope", no = "Top")
```


# Change Bay Area for 18, 26 and F7-18
```{r}
Symcap$Bay.Area[which(Symcap$Reef.ID=="26")] <- "Central"
Symcap$Bay.Area[which(Symcap$Reef.ID=="18")] <- "Southern"
Symcap$Bay.Area[which(Symcap$Reef.ID=="F7-18")] <- "Southern"
```


# Adjust Depth by Mean Sea Level
To account for the influence of tides, depth was adjusted according to the differences in mean sea level from the recorded sea level on each collection day to the nearest 6-minute interval. Mean sea level was obtained from NOAA daily tide tables for Moku o Lo'e.
```{r Adjust Depth, warning=FALSE, message=FALSE, results='hide'}
JuneTide=read.csv("Tide Tables/Station_1612480_tide_ht_20160601-20160630.csv")
JulyTide=read.csv("Tide Tables/Station_1612480_tide_ht_20160701-20160731.csv")
AugustTide=read.csv("Tide Tables/Station_1612480_tide_ht_20160801-20160812.csv")
Tide<-rbind(JuneTide, JulyTide, AugustTide)
Tide$Time <- as.POSIXct(Tide$TimeUTC, format="%Y-%m-%d %H:%M:%S", tz="UTC")
attributes(Tide$Time)$tzone <- "Pacific/Honolulu"
Symcap$Time2 <- as.POSIXct(paste(as.character(Symcap$Date), as.character(Symcap$Time)),
                                format="%m/%d/%y %H:%M", tz="Pacific/Honolulu")
Symcap$Time=Symcap$Time2

# Add estimated times for missing values
Symcap$Time[170] <- as.POSIXct("2016-06-14 12:07:00")
Symcap$Time[177] <- as.POSIXct("2016-06-14 12:20:00")
Symcap$Time[178] <- as.POSIXct("2016-06-14 12:22:00")
Symcap$Time[180] <- as.POSIXct("2016-06-14 13:08:00")
Symcap$Time[187] <- as.POSIXct("2016-06-14 12:42:00")
Symcap$Time[188] <- as.POSIXct("2016-06-14 12:44:00")
Symcap$Time[206] <- as.POSIXct("2016-06-16 13:10:00")
Symcap$Time[208] <- as.POSIXct("2016-06-16 13:24:00")
Symcap$Time[211] <- as.POSIXct("2016-06-16 12:37:00")
Symcap$Time[218] <- as.POSIXct("2016-06-16 12:27:00")
Symcap$Time[448] <- as.POSIXct("2016-07-16 13:32:00")

Round6 <- function (times)  {
  x <- as.POSIXlt(times)
  mins <- x$min
  mult <- mins %/% 6
  remain <- mins %% 6
  if(remain > 3L) {
    mult <- mult + 1
  } else {
    x$min <- 6 * mult
  }
  x <- as.POSIXct(x)
  x
}

Symcap$Time.r <- Round6(Symcap$Time)
Tide$Time.r <- Tide$Time
merged<-merge(Symcap, Tide, by="Time.r", all.x=T)
merged$newDepth <- merged$Depth..m.- merged$TideHT
```


# Create Color Data Frame
```{r}
rc <- read.csv("Data/Collection Data/RC_color.csv", header=F)
colnames(rc) <- c("Colony", "RC")
jk <- read.csv("Data/Collection Data/JK_color.csv", header=F)
colnames(jk) <- c("Colony", "JK")
cw <- read.csv("Data/Collection Data/CW_color.csv", header=F)
colnames(cw) <- c("Colony", "CW")
rrw <- read.csv("Data/Collection Data/RRW_color.csv", header=F)
colnames(rrw) <- c("Colony", "RRW")
ti <- read.csv("Data/Collection Data/Coral_Collection.csv")
ti <- ti[,c("Colony", "Color.Morph")]
colnames(ti) <- c("Colony", "TI")
ti$TI <- ifelse(ti$TI=="Orange", "o", "b")
df <- merge(merge(merge(merge(rc, rrw, by="Colony"), ti, by="Colony"), cw, by="Colony"), jk, by="Colony")
df$RC <- ifelse(df$RC=="o", "Orange", "Brown")
df$RRW <- ifelse(df$RRW=="o", "Orange", "Brown")
df$TI <- ifelse(df$TI=="o", "Orange", "Brown")
df$CW <- ifelse(df$CW=="o", "Orange", "Brown")
df$JK <- ifelse(df$JK=="o", "Orange", "Brown")
df$NAG <- apply(df[,-1], 1, function(x) max(table(x)))
Majority <- read.csv("Data/Collection Data/Majority.csv", header = T)
df <- merge(df, Majority, by="Colony")
```


# Set Color Morph Column to New Data Frame Column
```{r}
Symcap <- subset(Symcap, Colony!="7")
Symcap$Color.Morph <- df$Majority
merged <- subset(merged, Colony!="7")
merged$Color.Morph <- df$Majority
```


# Color Morph Per Reef Area
```{r}
Symcap$Reef.Area <- ifelse(Symcap$Reef.Area!="Top", yes = "Slope", no = "Top")
results=table(Symcap$Color.Morph, Symcap$Reef.Area)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray100"), xlab = "Reef Area", ylab = "Color Morph Proportion")
legend("topright", legend=c("Brown", "Orange"), fill=c("gray10", "gray100"), inset = c(-.2, 0), xpd = NA)
```


## Color Morph Uncertainty Per Reef Area
```{r}
Symcap$Reef.Area <- ifelse(Symcap$Reef.Area!="Top", yes = "Slope", no = "Top")
results=table(df$NAG, Symcap$Reef.Area)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray50", "gray100"), xlab = "Reef Area", ylab = "Color Morph Proportion")
legend("topright", legend=c("3 Agreements", "4 Agreements", "5 Agreements"), fill=c("gray10", "gray50", "gray100"), inset = c(-.2, 0), xpd = NA)
```


# Color Morph Per Bay Area
```{r}
results=table(Symcap$Color.Morph, Symcap$Bay.Area)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray100"), xlab = "Bay Area", ylab = "Color Morph Proportion")
legend("topright", legend=c("Brown", "Orange"), fill=c("gray10", "gray100"), inset = c(-.2, 0), xpd = NA)
```


## Color Morph Uncertainty Per Bay Area
```{r}
results=table(df$NAG, Symcap$Bay.Area)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray50", "gray100"), xlab = "Bay Area", ylab = "Color Morph Proportion")
legend("topright", legend=c("3 Agreements", "4 Agreements", "5 Agreements"), fill=c("gray10", "gray50", "gray100"), inset = c(-.2, 0), xpd = NA)
```


# Color Morph Per Dominant Symbiont
```{r}
results=table(Symcap$Color.Morph, Symcap$Dom)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray100"), xlab = "Dominant Symbiont", ylab = "Color Morph Proportion")
legend("topright", legend=c("Brown", "Orange"), fill=c("gray10", "gray100"), inset = c(-.2, 0), xpd = NA)
```


## Color Morph Uncertainty Per Dominant Symbiont
```{r}
results=table(df$NAG, Symcap$Dom)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray50", "gray100"), xlab = "Dominant Symbiont", ylab = "Color Morph Proportion")
legend("topright", legend=c("3 Agreements", "4 Agreements", "5 Agreements"), fill=c("gray10", "gray50", "gray100"), inset = c(-.2, 0), xpd = NA)
```


# Color Morph Per Symbiont Mixture
```{r}
results=table(Symcap$Color.Morph, Symcap$Mix)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray100"), xlab = "Mixture", ylab = "Color Morph Proportion")
legend("topright", legend=c("Brown", "Orange"), fill=c("gray10", "gray100"), inset = c(-.2, 0), xpd = NA)
```


## Color Morph Uncertainty Per Symbiont Mixture
```{r}
results=table(df$NAG, Symcap$Mix)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray50", "gray100"), xlab = "Mixture", ylab = "Color Morph Proportion")
legend("topright", legend=c("3 Agreements", "4 Agreements", "5 Agreements"), fill=c("gray10", "gray50", "gray100"), inset = c(-.2, 0), xpd = NA)
```


#Color Morph Uncertainty Per Symbiont Proportion
```{r}
merged$PropInt <- cut(merged$propD, breaks = 20)
results=table(df$NAG, merged$PropInt)
results
props <- prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6), lwd = 0.25)
barplot(props, col = c("gray10", "gray50", "gray100"), 
        xlab = "Proportion of D", ylab = "Color Morph Uncertainty",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("3 Agreements", "4 Agreements", "5 Agreements"), fill=c("gray10", "gray50", "gray100"), inset = c(-.22, 0), xpd = NA)
par(new = T)
par(mar=c(4.2, 4, 2, 6))
```


# Color Morph Per Reef ID
```{r}
results=table(Symcap$Color.Morph, Symcap$Reef.ID)
chisq.test(results)
prop.table(results, margin = 2)
```


## Color Morph Uncertainty Per Reef ID
```{r}
results=table(df$NAG, Symcap$Reef.ID)
chisq.test(results)
prop.table(results, margin = 2)
```


# Color Morph Uncertainty per Color Morph
```{r}
results=table(df$NAG, Symcap$Color.Morph)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray50", "gray100"), xlab = "Color Morph", ylab = "Color Morph Uncertainty")
legend("topright", legend=c("3 Agreements", "4 Agreements", "5 Agreements"), fill=c("gray10", "gray50", "gray100"), inset = c(-.2, 0), xpd = NA)
```


# Color Morph Across Depths
```{r ColorMorph~Depth, message=FALSE, warning=FALSE}
merged$DepthInt <- cut(merged$newDepth, breaks = 0:13)
merged$Color <- ifelse(merged$Color.Morph=="Orange", 0, 1)
results=table(merged$Color, merged$DepthInt)
results
props <- prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6), lwd = 0.25)
barplot(props[,1:11], col = c(alpha("orange", 0.25), alpha("sienna", 0.25)), 
        xlab = "", ylab = "",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("Brown", "Orange"), fill=c(alpha("sienna", 0.25), alpha("orange", 0.25)), inset = c(-.22, 0), xpd = NA)
par(new = T)
par(mar=c(4.2, 4, 2, 6))
merged$Color2 <- ifelse(merged$Color=="0", 1, 0)
results=glm(Color2~newDepth, family = "binomial", data = merged)
fitted <- predict(results, newdata = list(newDepth=seq(0,11,0.1)), type = "response")
plot(fitted~seq(0,11,0.1), xaxs="i", yaxs="i", xlim=c(0,11), ylim=c(0,1), type="l", lwd = 3, xlab="Depth (m)", ylab="Probability of Orange-Dominance")
```
Bars indicate relative frequency of Brown vs. Orange color morph dominance at 1m depth intervals when pooling all samples collected. The overlaid line indicates the probablity of a colony to be Orange across depths.


## Color Morph Uncertainty (4 Agreements) Across Depths
```{r}
merged$DepthInt <- cut(merged$newDepth, breaks = 0:13)
merged$Uncertainty4 <- ifelse(df$NAG=="4", 0, 1)
results=table(merged$Uncertainty4, merged$DepthInt)
results
props <- prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6), lwd = 0.25)
barplot(props[,1:11], col = c("gray50", "gray100"), 
        xlab = "", ylab = "",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("4 Agreements", "Others"), fill=c("gray 50", "gray100"), inset = c(-.22, 0), xpd = NA)
par(new = T)
par(mar=c(4.2, 4, 2, 6))
merged$Uncertainty2 <- ifelse(df$NAG=="4", 1, 0)
results=glm(Uncertainty2~newDepth, family = "binomial", data = merged)
fitted <- predict(results, newdata = list(newDepth=seq(0,11,0.1)), type = "response")
plot(fitted~seq(0,11,0.1), xaxs="i", yaxs="i", xlim=c(0,11), ylim=c(0,1), type="l", lwd = 3, xlab="Depth (m)", ylab="Probability of 4 Agreements")
```

## Color Morph Uncertainty (3 Agreements) Across Depths
```{r}
merged$DepthInt <- cut(merged$newDepth, breaks = 0:13)
merged$Uncertainty3 <- ifelse(df$NAG=="3", 0, 1)
results=table(merged$Uncertainty3, merged$DepthInt)
results
props <- prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6), lwd = 0.25)
barplot(props[,1:11], col = c("gray50", "gray100"), 
        xlab = "", ylab = "",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("3 Agreements", "Others"), fill=c("gray 50", "gray100"), inset = c(-.22, 0), xpd = NA)
par(new = T)
par(mar=c(4.2, 4, 2, 6))
merged$Uncertainty1 <- ifelse(df$NAG=="3", 1, 0)
results=glm(Uncertainty1~newDepth, family = "binomial", data = merged)
fitted <- predict(results, newdata = list(newDepth=seq(0,11,0.1)), type = "response")
plot(fitted~seq(0,11,0.1), xaxs="i", yaxs="i", xlim=c(0,11), ylim=c(0,1), type="l", lwd = 3, xlab="Depth (m)", ylab="Probability of 3 Agreements")
```


# Dominant Symbiont by Color Morph and Depth
```{r}
Symcap <- subset(Symcap, Colony!="7")
Symcap$Color.Morph <- df$Majority
merged <- subset(merged, Colony!="7")
merged$Color.Morph <- df$Majority
merged$Dominant <- ifelse(merged$Dom=="C", 0, 1)
df <- subset(merged, Color.Morph=="Orange")
results=glm(Dominant~newDepth, family = "binomial", data = df)
newdata <- list(newDepth=seq(0,11,0.01))
par(mar=c(4, 4, 2, 6))
fitted <- predict(results, newdata = newdata, type = "response")
plot(fitted ~ seq(0,11,0.01), ylim = c(0,1), type="l", col="orange", lwd=3, xlab="", ylab="", axisnames=FALSE)
abline(h = 0.5, lty=2)
df <- subset(merged, Color.Morph=="Brown")
results=glm(Dominant~newDepth, family = "binomial", data = df)
newdata <- list(newDepth=seq(0,11,0.01))
fitted <- predict(results, newdata = newdata, type = "response")
lines(fitted~seq(0,11,0.01), col="sienna", lwd=3)
mtext(side = 1, text = "Depth (m)", line = 3, cex = 1)
mtext(side = 2, text = "Probability of Clade D Symbiont", line = 3, cex = 1)
legend("topright", legend=c("Brown", "Orange"), fill=c("sienna", "orange"), inset = c(-.22, 0), xpd = NA)
```