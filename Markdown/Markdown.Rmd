---
title: "Symcap"
author: "Teegan Innis"
date: "March 9, 2017"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: true
    code_folding: hide
---
--------------------------------------------------------------------------------------
# Project Summary
This project aimed to look at the spatial variability of color morph and *Symbiodinium* clades C and D present in the Kane'ohe Bay, O'ahu, Hawai'i population of Montipora capitata. We investigated the distributions at scales ranging from location within the bay to location on an individual reef. We also looked at differences among reef types (fringing vs. patch) and depths. Heterogeneous mixtures of symbiont clades were considered in the analysis for spatial patterns. By investigating spatial variability of *Symbiodinium*, we furthered the understanding of potential stress-response in Kane'ohe Bay.


# Load Packages
```{r Library Packages Needed, warning=FALSE, message=FALSE}
knitr::opts_knit$set(root.dir = normalizePath(".."))
library(data.table)
library(lsmeans)
library(devtools)
library(plyr)
library(reshape2)
#library(popbio)
library(RgoogleMaps)
library(plotrix)
library(zoo)
library(rgdal)
library(car)
library(scales)
library(png)
#library(pixmap)
library(ecodist)
#library(cluster)
#library(fpc)
#library(clustsig)
#library(mapplots)
#library(foreign)
library(nnet)
#library(ggplot2)
#library(mlogit)
```


# Import Data
### Import Sample Metadata
```{r}
Coral_Data <- read.csv("Data/Collection Data/Coral_Collection.csv")
Coral_Data$Depth..m. <- as.numeric(as.character(Coral_Data$Depth..m.))
```


### Import qPCR Data
```{r, message=FALSE}
#source_url("https://raw.githubusercontent.com/jrcunning/steponeR/master/steponeR.R")
source("~/Documents/Academia/HIMB/steponeR/steponeR.R")
Mcap.plates <- list.files(path = "Data/qPCR_data", pattern = "txt$", full.names = T)
Mcap <- steponeR(files = Mcap.plates, delim="\t",
                 target.ratios=c("C.D"), 
                 fluor.norm = list(C=2.26827, D=0), 
                 copy.number=list(C=33, D=3))
Mcap <- Mcap$result

# Remove positive and negative controls from qPCR data
Mcap <- Mcap[grep("+", Mcap$Sample.Name, fixed=T, invert = T), ]
Mcap <- Mcap[grep("NTC", Mcap$Sample.Name, fixed = T, invert = T), ]
Mcap <- Mcap[grep("PCT", Mcap$Sample.Name, fixed = T, invert = T), ]

# Change "Sample.Name" column to "Colony"
colnames(Mcap)[which(colnames(Mcap)=="Sample.Name")] <- "Colony"

# Filter out detections without two technical replicates
Mcap$fail <- ifelse(Mcap$C.reps < 2 & Mcap$D.reps < 2, TRUE, FALSE)
fails <- Mcap[Mcap$fail==TRUE, ]
Mcap <- Mcap[which(Mcap$fail==FALSE),]

# Set C:D ratio to -Inf (when only D) and Inf (when only C)
Mcap$C.D[which(Mcap$C.reps<2)] <- -Inf
Mcap$C.D[which(Mcap$D.reps<2)] <- Inf

# Order qPCR data by Colony
Mcap <- Mcap[with(Mcap, order(Colony)), ]

# Calculate Proportion C and Proportion D
Mcap$propC <- Mcap$C.D / (Mcap$C.D+1)
Mcap$propD <- 1-Mcap$propC
Mcap$propD[which(Mcap$C.D==-Inf)] <-1
Mcap$propC[which(Mcap$C.D==-Inf)] <-0
Mcap$propD[which(Mcap$C.D==Inf)] <-0
Mcap$propC[which(Mcap$C.D==Inf)] <-1

# Categorize each sample as C-dominated or D-dominated
Mcap$Dom <- ifelse(Mcap$propC>Mcap$propD, "C", "D")
```


### Merge Sample Metadata with qPCR Data
```{r}
Symcap<-merge(Coral_Data, Mcap, by="Colony", all=T)
Symcap <- Symcap[with(Symcap, order(Colony)), ]

# Define category for symbiont mixture
Symcap$Mix <- factor(ifelse(Symcap$propC>Symcap$propD, ifelse(Symcap$propD!=0, "CD", "C"), ifelse(Symcap$propD>Symcap$propC, ifelse(Symcap$propC!=0, "DC", "D"), NA)), levels = c("C", "CD", "DC", "D"))
```


### Import Color Data
```{r}
colscores <- read.csv("Data/Collection Data/Color_Scores.csv")

# Determine color scores by majority rule, and number of agreements
colscores$majority <- apply(colscores[,-1], 1, function(x) names(table(x))[which.max(table(x))])
colscores$n.agree <- apply(colscores[,-c(1,7)], 1, function(x) max(table(x)))

# Set which set of color scores will be used in analysis (=majority)
Symcap <- merge(Symcap, colscores[,c("Colony","majority","n.agree")], all=T)
Symcap$Color.Morph <- factor(Symcap$majority)

# Set color/symbiont groupings
Symcap$ColDom <- interaction(Symcap$Color.Morph, Symcap$Dom)
```


### Change Bay Area for 18, 26 and F7-18
```{r}
Symcap$Bay.Area[which(Symcap$Reef.ID=="26")] <- "Central"
Symcap$Bay.Area[which(Symcap$Reef.ID=="18")] <- "Southern"
Symcap$Bay.Area[which(Symcap$Reef.ID=="F7-18")] <- "Southern"
```


### Adjust Depth by Mean Sea Level
To account for the influence of tides, depth was adjusted according to the differences in mean sea level from the recorded sea level on each collection day to the nearest 6-minute interval. Mean sea level was obtained from NOAA daily tide tables for Moku o Lo'e.
```{r Adjust Depth, warning=FALSE, message=FALSE, results='hide'}
JuneTide=read.csv("Tide Tables/Station_1612480_tide_ht_20160601-20160630.csv")
JulyTide=read.csv("Tide Tables/Station_1612480_tide_ht_20160701-20160731.csv")
AugustTide=read.csv("Tide Tables/Station_1612480_tide_ht_20160801-20160812.csv")
Tide<-rbind(JuneTide, JulyTide, AugustTide)
Tide$Time <- as.POSIXct(Tide$TimeUTC, format="%Y-%m-%d %H:%M:%S", tz="UTC")
attributes(Tide$Time)$tzone <- "Pacific/Honolulu"
Symcap$Time2 <- as.POSIXct(paste(as.character(Symcap$Date), as.character(Symcap$Time)),
                                format="%m/%d/%y %H:%M", tz="Pacific/Honolulu")
Symcap$Time=Symcap$Time2

# Add estimated times for missing values
Symcap$Time[170] <- as.POSIXct("2016-06-14 12:07:00")
Symcap$Time[177] <- as.POSIXct("2016-06-14 12:20:00")
Symcap$Time[178] <- as.POSIXct("2016-06-14 12:22:00")
Symcap$Time[180] <- as.POSIXct("2016-06-14 13:08:00")
Symcap$Time[187] <- as.POSIXct("2016-06-14 12:42:00")
Symcap$Time[188] <- as.POSIXct("2016-06-14 12:44:00")
Symcap$Time[206] <- as.POSIXct("2016-06-16 13:10:00")
Symcap$Time[208] <- as.POSIXct("2016-06-16 13:24:00")
Symcap$Time[211] <- as.POSIXct("2016-06-16 12:37:00")
Symcap$Time[218] <- as.POSIXct("2016-06-16 12:27:00")
Symcap$Time[448] <- as.POSIXct("2016-07-16 13:32:00")

Round6 <- function (times)  {
  x <- as.POSIXlt(times)
  mins <- x$min
  mult <- mins %/% 6
  remain <- mins %% 6
  if(remain > 3L) {
    mult <- mult + 1
  } else {
    x$min <- 6 * mult
  }
  x <- as.POSIXct(x)
  x
}

Symcap$Time.r <- Round6(Symcap$Time)
Tide$Time.r <- Tide$Time
Symcap<-merge(Symcap, Tide, by="Time.r", all.x=T)
Symcap$newDepth <- Symcap$Depth..m.- Symcap$TideHT
```

# Analyze color morph data
```{r}
# Plot color assignment strength by color-symbiont groupings
uncert <- aggregate(Symcap$n.agree, by=list(Symcap$ColDom), FUN=table)
data.frame(ColDom=uncert[,1], prop.table(uncert[,-1], margin=1))
barplot(t(uncert)[-1,], names.arg=uncert[,1], ylab="Number of colonies")
legend("top", legend=c("5/5 agree", "4/5 agree", "3/5 agree"), fill=c("gray90", "gray60", "gray30"), title="Color assignment strength")

# Plot number of color-symbiont groups by depth
Symcap$depthInt <- cut(Symcap$newDepth, breaks=seq(0,10,1))
barplot(prop.table(table(Symcap$ColDom, Symcap$depthInt), margin=2),
        col=c("burlywood4","darkorange3","burlywood3","darkorange"))
legend("bottomright", inset=0.05, legend=c("Brown.C", "Brown.D","Orange.C",  "Orange.D"),
       fill=c("burlywood4","burlywood3","darkorange3","darkorange"))

# Filter out low confidence color assignments
Symcap <- Symcap[which(Symcap$n.agree > 3), ]

# Plot probability of symbiont-color groups
depthmod <- multinom(ColDom ~ newDepth, Symcap)
depthdat <- data.frame(newDepth = seq(0,12,0.5))
depthpred <- predict(depthmod, newdata=depthdat, "probs")
stackpoly(depthpred[,c(4,2,3,1)], stack=T, col=rev(c("burlywood4","burlywood3","darkorange3","darkorange")),
          ylim=c(0,1), xaxlab=depthdat$newDepth, xlab="Depth", ylab="Probability")
legend("topright", legend=c("Brown.C",  "Brown.D", "Orange.C","Orange.D"), pch=22,
       pt.bg=c("burlywood4","burlywood3","darkorange3","darkorange"))
```

# Figure 1: Coral Collection Map
Collection sites represented on this map indicate the 9 fringe and 16 patch reef sites for a total of 25 collection reefs. In total, 707 colonies were collected for the analysis.
```{r Collection Map, message=FALSE, warning=FALSE, results='hide', eval=F}
# Define map area and get satellite data from Google using RgoogleMaps
KB <- c(21.46087401, -157.809907) 
KBMap <- GetMap(center = KB, zoom = 13, maptype = "satellite", SCALE = 2, GRAYSCALE = FALSE)
save(KBMap, file = "KBMap.Rdata")
load("KBMap.Rdata") 

# Get representative coordinates for each reef based on sample GPS data
Latitude=aggregate(Latitude~Reef.ID, data=Symcap, FUN = mean)
Longitude=aggregate(Longitude~Reef.ID, data = Symcap, FUN=mean)
XY<-merge(Latitude, Longitude, by="Reef.ID", all=T)
newcoords <- LatLon2XY.centered(KBMap, XY$Latitude, XY$Longitude, zoom=13)
XY$X <- newcoords$newX
XY$Y <- newcoords$newY

# Remove mislabeled reef causing duplicate colony ID's
XY <- subset(XY, Reef.ID!="37") 

# Plot KBay Map
par(oma=c(3,3,0,0))
PlotOnStaticMap(KBMap, XY$Latitude, XY$Longitude, col=153, pch=21, bg="#FF7F50", lwd=2, cex = 1.2)
axis(1, at = LatLon2XY.centered(KBMap, NA, c(-157.85, -157.81, -157.77))$newX, tcl=0.5, line = 0.5, col = "ghostwhite", col.ticks = "black", lwd = 1, outer = TRUE, labels = c("157.85°W", "157.81°W", "157.77°W"), padj = -2.5, cex.axis = 0.75)
axis(2, at = LatLon2XY.centered(KBMap, c(21.42, 21.46, 21.50), NA)$newY, tcl=0.5, line = 0.5, col = "ghostwhite", col.ticks = "black", lwd = 1, outer = TRUE, labels = c("21.42°N", "21.46°N", "21.50°N"), padj = 0.5, hadj = 0.60, las = 1, cex.axis = 0.75)
par(new=T, mar=c(14,21,0,0))
HI <- readOGR("coast_n83.shp", "coast_n83") 
HI <- spTransform(HI, CRS("+proj=longlat +datum=NAD83")) 
plot(HI, xlim=c(-158.3, -157.6), ylim=c(21.35, 21.6), lwd=0.4, col="gray", bg="white")
rect(-157.87, 21.41, -157.75, 21.52)
box()
```

# Color agreement
```{r col_agreement}
Symcap$unan <- ifelse(Symcap$n.agree==5, T, F)
Symcap$only3 <- ifelse(Symcap$n.agree==3, T, F)
mod <- glm(cbind(n.agree, 5-n.agree) ~ newDepth * Color.Morph, family="binomial", Symcap)
anova(mod, test = "Chisq")
newdat <- data.frame(newDepth=seq(1,10,0.1), Color.Morph="Orange")
plot(newdat$newDepth, predict(mod, newdata=newdat, type="response"), ylim=c(0,1), col="orange", type="l", lwd=2)
newdat <- data.frame(newDepth=seq(1,10,0.1), Color.Morph="Brown")
lines(newdat$newDepth, predict(mod, newdata=newdat, type="response"), col="brown", lwd=2)

par(mfrow=c(2,1))
plot(n.agree ~ newDepth, data=subset(Symcap, Color.Morph=="Orange"), col="orange")
plot(n.agree ~ newDepth, data=subset(Symcap, Color.Morph=="Brown"), col="brown")
```


# Symbiont and Color Morph Communities
## Symbiont Dominance
```{r}
table(Symcap$Dom)
```


## Symbiont Community Composition
```{r}
table(Symcap$Mix)
```


## Symbiont Community Composition per Dominant Symbiont
```{r, warning=FALSE}
results=table(Symcap$Mix, Symcap$Dom)
chisq.test(results)
prop.table(results, margin = 2)
```


### Figure 3: Symbiont Community Composition per Dominant Symbiont 
```{r}
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c(alpha("blue", 0.75), alpha("blue", 0.25), alpha("red", 0.25), alpha("red", 0.75)), xlab = "Dominant Symbiont", ylab = "Proportion of Colonies")
legend("topright", legend=c("C", "CD", "DC", "D"), fill=c(alpha("blue", 0.75), alpha("blue", 0.25), alpha("red", 0.25), alpha("red", 0.75)), inset = c(-.2, 0), xpd = NA)
```

When looking at D-only colonies, the Ct values are on the higher end of the spectrum (35 or greater) indicating poor amplification and the potential for C amplification being pushed back in the cycle. This is supported by the fact that 5 of the 9 D-only colonies had C present in 1 qPCR replicate.


## Color Morph Dominance
```{r}
table(Symcap$Color.Morph)
```


## Dominant Symbiont per Color Morph
```{r Dom~ColorMorph}
results=table(Symcap$Dom, Symcap$Color.Morph)
results
mosaicplot(results, xlab = "Dominant Symbiont", ylab = "Color Morph", main = "")
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray100"), xlab = "Color Morph", ylab = "Symbiont Proportion")
legend("topright", legend=c("C", "D"), fill=c("gray10", "gray100"), inset = c(-.2, 0), xpd = NA)
```


## Symbiont Community Composition per Color Morph
```{r Mix~ColorMorph, warning=FALSE}
results=table(Symcap$Mix, Symcap$Color.Morph)
chisq.test(results)
prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6))
barplot(prop.table(results, margin = 2), col = c("gray10", "gray50", "gray85", "gray100"), xlab = "Color Morph", ylab = "Symbiont Community Composition")
legend("topright", legend=c("C", "CD", "DC", "D"), fill=c("gray10", "gray50", "gray85", "gray100"), inset = c(-.2, 0), xpd = NA)
```


### Proportion of D When Present in Mixture
```{r propD Histogram, warning=FALSE, cache=TRUE, fig.width=5}
propD <- Symcap$propD[which(Symcap$propD > 0 & Symcap$propD < 1)]
hist(propD, xlab = "Proportion of Clade D", ylab = "Number of Samples", main = "", col = "gray75")
```


### Figure 4: Symbiont Community Composition and Color Morph
```{r, DHistogram}
propD <- Symcap$propD[which(Symcap$propD > 0 & Symcap$propD < 1)]

propDHist <- subset(Symcap, propD > 0 & propD < 1)
propDHist$propD <- cut(propDHist$propD, breaks = 5)
DCol=table(propDHist$Color.Morph, propDHist$propD)
z <- with(subset(Symcap, propD==0), table(Color.Morph))
o <- with(subset(Symcap, propD==1), table(Color.Morph))
DCol <- cbind(z, DCol, o)
par(mar=c(4, 4, 2, 0))
bars <- barplot(DCol, xlab = "Clade D Proportion", ylab = "Number of Samples", main = "", col = c(alpha("sienna", 0.55), alpha("orange", 0.55)), axisnames = FALSE, space = c(0,0.3,0,0,0,0,0.3))
axis(side = 1, at = c(1.3, 2.3, 3.3, 4.3, 5.3, 6.3), labels = c(">0%", "20%", "40%", "60%", "80%", "<100%"))
axis(side = 1, at = c(0.5, 7.2), labels = c("All C", "All D"), tick = FALSE)
```


# Symbiont and Color Morph Communities Across Depths
## Dominant Symbiont by Depth
```{r Dom~Depth, message=FALSE, warning=FALSE}
Symcap$Dominant <- ifelse(Symcap$Dom=="C", 0, 1)
Dom1 <- subset(Symcap, !is.na(newDepth) & !is.na(Dominant))
results=glm(Dominant~newDepth, family = "binomial", data = Symcap)
anova(results, test = "Chisq")

Symcap$DepthInt <- cut(Symcap$newDepth, breaks = 0:13)
Symcap$Dominant2 <- ifelse(Symcap$Dom=="C", 1, 0)
results=table(Symcap$Dominant2, Symcap$DepthInt)

props <- prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6), lwd = 0.25)
barplot(props[,1:11], col = c(alpha("red", 0.25), alpha("blue", 0.25)), 
        xlab = "", ylab = "",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("C", "D"), fill=c(alpha("blue", 0.25), alpha("red", 0.25)), inset = c(-.2, 0), xpd = NA)
par(new = T)
par(mar=c(4.2, 4, 2, 6))
results=glm(Dominant~newDepth, family = "binomial", data = Symcap)
fitted <- predict(results, newdata = list(newDepth=seq(0,11,0.01)), type = "response")
plot(fitted~seq(0,11,0.01), xaxs="i", yaxs="i", xlim=c(0,11), ylim=c(0,1), type="l", lwd = 3, xlab="Depth (m)", ylab="Probability of D-Dominance")

# Depth at which probability of C vs. D dominance is 50/50
seq(0,11,0.01)[which.min(abs(fitted-0.5))]
```

Bars indicate relative frequency of occurence of clade C vs. D dominance at 1m depth intervals when pooling all samples collected. Overlaid line indicates probability of a colony being D-dominated across depths.


## Color Morph by Depth
```{r ColorMorph~Depth, message=FALSE, warning=FALSE}
Symcap$Color <- ifelse(Symcap$Color.Morph=="Orange", 0, 1)
results=glm(Color~newDepth, family = "binomial", data = Symcap)
anova(results, test = "Chisq")
Color <- subset(Symcap, !is.na(newDepth) & !is.na(Color))

results=table(Symcap$Color, Symcap$DepthInt)

props <- prop.table(results, margin = 2)
par(mar=c(4, 4, 2, 6), lwd = 0.25)
barplot(props[,1:11], col = c(alpha("orange", 0.25), alpha("sienna", 0.25)), 
        xlab = "", ylab = "",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("Brown", "Orange"), fill=c(alpha("sienna", 0.25), alpha("orange", 0.25)), inset = c(-.22, 0), xpd = NA)
par(new = T)
par(mar=c(4.2, 4, 2, 6))
Symcap$Color2 <- ifelse(Symcap$Color=="0", 1, 0)
results=glm(Color2~newDepth, family = "binomial", data = Symcap)
fitted <- predict(results, newdata = list(newDepth=seq(0,11,0.01)), type = "response")
plot(fitted~seq(0,11,0.01), xaxs="i", yaxs="i", xlim=c(0,11), ylim=c(0,1), type="l", lwd = 3, xlab="Depth (m)", ylab="Probability of Orange-Dominance")

# Depth at which probability of orange or brown is 50/50
seq(0,11,0.01)[which.min(abs(fitted-0.5))]
```
Bars indicate relative frequency of brown vs. orange color morph dominance at 1m depth intervals when pooling all samples collected. The overlaid line indicates the probablity of a colony to be orange across depths.


# Color Morph and Dominant Symbiont Interaction
## Depth at which Orange switches from D to C Dominance
While brown colonies were always more likely C-dominated, orange colonies were observed to switch from D to C dominance. The depth threshold where this switch occurred is represented here.
```{r, warning=FALSE}
# Probability of C vs. D dominance in Orange and Brown colonies across Depth
# Orange colonies
df <- subset(Symcap, Color.Morph=="Orange")
results=glm(Dominant~newDepth, family = "binomial", data = df)
newdata <- list(newDepth=seq(0,11,0.01))
par(mar=c(4, 4, 2, 6))
fitted <- predict(results, newdata = newdata, type = "response")
plot(fitted ~ seq(0,11,0.01), ylim = c(0,1), type="l", col="orange", lwd=3, xlab="", ylab="", axisnames=FALSE)
abline(h = 0.5, lty=2)
# Point at which probability of C or D dominance is 50/50
seq(0,11,0.01)[which.min(abs(fitted-0.5))]
# Probability of D-dominance at 1m
fitted[seq(0,11,0.01)==1]
# Probability of D-dominance at 10m
fitted[seq(0,11,0.01)==11]

# Brown colonies
df <- subset(Symcap, Color.Morph=="Brown")
results=glm(Dominant~newDepth, family = "binomial", data = df)
newdata <- list(newDepth=seq(0,11,0.01))
fitted <- predict(results, newdata = newdata, type = "response")
lines(fitted~seq(0,11,0.01), col="sienna", lwd=3)
mtext(side = 1, text = "Depth (m)", line = 3, cex = 1)
mtext(side = 2, text = "Probability of Clade D Symbiont", line = 3, cex = 1)
legend("topright", legend=c("Brown", "Orange"), fill=c("sienna", "orange"), inset = c(-.22, 0), xpd = NA)
# Probability of D-dominance at 1m
fitted[seq(0,11,0.01)==1]
# Probability of D-dominance at 10m
fitted[seq(0,11,0.01)==10]
```

# Figure 5: Depth Influence on Dominant Symbiont and Color Morph
```{r 3-panel Depth, message=FALSE, warning=FALSE, results='hide', fig.height=6, fig.width=3.1}
par(mfrow=c(3,1))

Symcap$DepthInt <- cut(Symcap$newDepth, breaks = 0:13)
Symcap$Dominant <- ifelse(Symcap$Dom=="C", 0, 1)
Symcap$Dominant2 <- ifelse(Symcap$Dom=="C", 1, 0)
results=table(Symcap$Dominant2, Symcap$DepthInt)
results
props <- prop.table(results, margin = 2)
par(mar=c(2, 4, 2, 6), lwd = 0.25)
barplot(props[,1:11], col = c(alpha("red", 0.25), alpha("blue", 0.25)), 
        xlab = "", ylab = "",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("C", "D"), fill=c(alpha("blue", 0.25), alpha("red", 0.25)), inset = c(0, 0), xpd = NA)
par(new = T)
par(mar=c(2.1, 4, 2, 6))
results=glm(Dominant~newDepth, family = "binomial", data = Symcap)
fitted <- predict(results, newdata = list(newDepth=seq(0,11,0.1)), type = "response")
plot(fitted~seq(0,11,0.1), xaxs="i", yaxs="i", xlim=c(0,11), ylim=c(0,1), type="l", lwd = 3, xlab="", ylab="Probability of D-Dominance")

Symcap$Color <- ifelse(Symcap$Color.Morph=="Orange", 0, 1)
results=table(Symcap$Color, Symcap$DepthInt)
results
props <- prop.table(results, margin = 2)
par(mar=c(3, 4, 1, 6), lwd = 0.25)
barplot(props[,1:11], col = c(alpha("orange", 0.25), alpha("sienna", 0.25)), 
        xlab = "", ylab = "Probability of Orange-Dominance",
        space = 0, xaxs="i", yaxs="i", axisnames = FALSE)
par(lwd=1)
legend("topright", legend=c("Brown", "Orange"), fill=c(alpha("sienna", 0.25), alpha("orange", 0.25)), inset = c(0, 0), xpd = NA)
par(new = T)
par(mar=c(3.1, 4, 1, 6))
Symcap$Color2 <- ifelse(Symcap$Color=="0", 1, 0)
results=glm(Color2~newDepth, family = "binomial", data = Symcap)
fitted <- predict(results, newdata = list(newDepth=seq(0,11,0.1)), type = "response")
plot(fitted~seq(0,11,0.1), xaxs="i", yaxs="i", xlim=c(0,11), ylim=c(0,1), type="l", lwd = 3, xlab="", ylab="")

df <- subset(Symcap, Color.Morph=="Orange")
results=glm(Dominant~newDepth, family = "binomial", data = df)
newdata <- list(newDepth=seq(0,11,0.01))
par(mar=c(4, 4, 0, 6))
fitted <- predict(results, newdata = newdata, type = "response")
plot(fitted ~ seq(0,11,0.01), ylim = c(0,1), type="l", col="orange", lwd=3, xlab="Depth (m)", ylab="Probabilty of D-Dominance", axisnames=FALSE, xaxs = "i", yaxs = "i")
abline(h = 0.5, lty=2)
df <- subset(Symcap, Color.Morph=="Brown")
results=glm(Dominant~newDepth, family = "binomial", data = df)
newdata <- list(newDepth=seq(0,11,0.01))
fitted <- predict(results, newdata = newdata, type = "response")
lines(fitted~seq(0, 11, 0.01), col="sienna", lwd=3)
legend("topright", legend=c("Brown", "Orange"), fill=c("sienna", "orange"), inset = c(0, 0), xpd = NA)
```




# Everything below here needs better commenting and organization.... very hard to follow!
```{r, eval=F}
Symcap$Dominant <- ifelse(Symcap$Dom=="C", 0, 1)
dat <- aggregate(data.frame(prop=Symcap$Dominant), by=list(Reef.ID=Symcap$Reef.ID), 
                 FUN=mean, na.rm=T) #prop D/reef
mod <- glm(Dominant ~ newDepth + Reef.ID, data=Symcap)
mod2 <- glm(Dominant ~ newDepth * Reef.ID, data=Symcap)
library(lsmeans)
lsm <- lsmeans(mod, specs="Reef.ID")
lsm2 <- lsmeans(mod2, specs="Reef.ID")
res <- merge(dat, data.frame(summary(lsm))[,c(1:2)], by="Reef.ID")
res <- merge(res, data.frame(summary(lsm2))[,c(1:2)], by="Reef.ID")
colnames(res) <- c("Reef.ID", "raw.c", "c.adj", "c.adj.int")

XY2 <- merge(XY, res, by = "Reef.ID")
XY2$d.adj <- 1-XY2$c.adj
XY2$d.adj.int <- 1-XY2$c.adj.int
XY2$raw.d <- 1-XY2$raw.c

manteltable = table(Symcap$Dom, Symcap$Color.Morph, Symcap$Reef.ID)
nc <- aggregate(interaction(Symcap$Color.Morph, Symcap$Dom), 
                by=list(Symcap$Reef.ID), FUN=table)
nc <- data.frame(Reef.ID=as.character(nc[,1]), prop.table(nc[,2], margin=1))
XY3 <- merge(XY2, nc, by="Reef.ID", all=T)

Symcap$ColDom <- interaction(Symcap$Color.Morph, Symcap$Dom)
model <- multinom(ColDom~newDepth+Reef.ID, na.omit(Symcap))
means <- lsmeans(model, specs = "Reef.ID")
means
```


```{r, ColorMorph~ReefID, warning=FALSE, echo=FALSE, include=FALSE}
results=table(Symcap$Color.Morph, Symcap$Reef.ID)
chisq.test(results)
```

```{r, warning=FALSE, results='hide', echo=FALSE, include=FALSE, eval=F}
Latitude=aggregate(Latitude~Reef.ID, data=Symcap, FUN = mean)
Longitude=aggregate(Longitude~Reef.ID, data = Symcap, FUN=mean)
XY<-merge(Latitude, Longitude, by="Reef.ID", all=T)
propCol=table(Symcap$Color.Morph, Symcap$Reef.ID)
propCol=prop.table(propCol, margin = 2)
propCol <- as.data.frame.matrix(propCol)
props <- data.frame(t(propCol))
props$Reef.ID <- rownames(props)
XY<-merge(XY, props, by="Reef.ID", all=T)
newcoords <- LatLon2XY.centered(KBMap, XY$Latitude, XY$Longitude, zoom=13)
XY$X <- newcoords$newX
XY$Y <- newcoords$newY
PlotOnStaticMap(KBMap, XY$Latitude, XY$Longitude)

rownames(XY) <- XY$Reef.ID
XY <- XY[, -1]
XY <- na.omit(XY)
apply(XY, MARGIN=1, FUN=function(reef) {
  floating.pie(xpos = reef["X"], ypos = reef["Y"], 
               x=c(reef["Orange"], reef["Brown"]), radius = 7, col = c("orange", "sienna"))
})
```


```{r, echo=FALSE, include=FALSE}
Latitude=aggregate(Latitude~Reef.ID, data=Symcap, FUN = mean)
Longitude=aggregate(Longitude~Reef.ID, data = Symcap, FUN=mean)
XY<-merge(Latitude, Longitude, by="Reef.ID", all=T)
propCol=table(Symcap$Color.Morph, Symcap$Reef.ID)
propCol=prop.table(propCol, margin = 2)
propCol <- as.data.frame.matrix(propCol)
props <- data.frame(t(propCol))
props$Reef.ID <- rownames(props)
XY<-merge(XY, props, by="Reef.ID", all=T)
reef.dists <- dist(cbind(XY$Longitude, XY$Latitude))
col.dists <- dist(XY$Brown)
set.seed(12456)
mantel(col.dists~reef.dists)
```


```{r, results='hide', include=FALSE, eval=F}
Symcap$Color <- ifelse(Symcap$Color.Morph=="Orange", 1, 0)
dat <- aggregate(data.frame(prop=Symcap$Color), by=list(Reef.ID=Symcap$Reef.ID), FUN=mean, na.rm=T) 
mod <- glm(Color ~ newDepth + Reef.ID, data=Symcap)
library(lsmeans)
lsm <- lsmeans(mod, specs="Reef.ID")
res <- merge(dat, data.frame(summary(lsm))[,c(1:2)], by="Reef.ID")
colnames(res) <- c("Reef.ID", "Raw", "O.Adj")

Latitude=aggregate(Latitude~Reef.ID, data=Symcap, FUN = mean)
Longitude=aggregate(Longitude~Reef.ID, data = Symcap, FUN=mean)
XY<-merge(Latitude, Longitude, by="Reef.ID", all=T)
propCol=table(Symcap$Color.Morph, Symcap$Reef.ID)
propCol=prop.table(propCol, margin = 2)
propCol <- as.data.frame.matrix(propCol)
props <- data.frame(t(propCol))
props$Reef.ID <- rownames(props)
XY<-merge(XY, props, by="Reef.ID", all=T)
newcoords <- LatLon2XY.centered(KBMap, XY$Latitude, XY$Longitude, zoom=13)
XY$X <- newcoords$newX
XY$Y <- newcoords$newY
PlotOnStaticMap(KBMap, XY$Latitude, XY$Longitude)
XY2 <- merge(XY, res, by = "Reef.ID")
XY2$B.Adj <- 1-XY2$O.Adj

PlotOnStaticMap(KBMap, XY$Latitude, XY$Longitude)

rownames(XY2) <- XY2$Reef.ID
XY2 <- XY2[, -1]
XY2 <- na.omit(XY2)
apply(XY2, MARGIN=1, FUN=function(reef) {
  floating.pie(xpos = reef["X"], ypos = reef["Y"], 
               x=c(reef["O.Adj"], reef["B.Adj"]), radius = 7, 
               col = c("orange", "sienna"))
})
```


```{r, echo=FALSE, include=FALSE, eval=F}
reef.dists <- dist(cbind(XY$Longitude, XY$Latitude))
col.dists <- dist(XY2$O.Adj)
set.seed(12456)
mantel(col.dists~reef.dists)
```


```{r, Dom~ReefType, echo=FALSE, include=FALSE, eval=F}
results=table(Symcap$Dom, Symcap$Reef.Type)
chisq.test(results)
```


```{r, Dom~BayArea, echo=FALSE, include=FALSE, eval=F}
results=table(Symcap$Dom, Symcap$Bay.Area)
chisq.test(results)
```


```{r, Dom~ReefID, warning=FALSE, echo=FALSE, include=FALSE}
results=table(Symcap$Dom, Symcap$Reef.ID)
chisq.test(results)
```

```{r, warning=FALSE, results='hide', include=FALSE, eval=F}
Latitude=aggregate(Latitude~Reef.ID, data=Symcap, FUN = mean)
Longitude=aggregate(Longitude~Reef.ID, data = Symcap, FUN=mean)
XY<-merge(Latitude, Longitude, by="Reef.ID", all=T)
propDom=table(Symcap$Dom, Symcap$Reef.ID)
propDom=prop.table(propDom, margin = 2)
propDom <- as.data.frame.matrix(propDom)
props <- data.frame(t(propDom))
props$Reef.ID <- rownames(props)
XY<-merge(XY, props, by="Reef.ID", all=T)
newcoords <- LatLon2XY.centered(KBMap, XY$Latitude, XY$Longitude, zoom=13)
XY$X <- newcoords$newX
XY$Y <- newcoords$newY
PlotOnStaticMap(KBMap, XY$Latitude, XY$Longitude)

rownames(XY) <- XY$Reef.ID
XY <- XY[, -1]
XY <- na.omit(XY)
apply(XY, MARGIN=1, FUN=function(reef) {
  floating.pie(xpos = reef["X"], ypos = reef["Y"], 
               x=c(reef["C"], reef["D"]), radius = 7, col = c("blue", "red"))
})
```


```{r, echo=FALSE, include=FALSE, eval=F}
Latitude=aggregate(Latitude~Reef.ID, data=Symcap, FUN = mean)
Longitude=aggregate(Longitude~Reef.ID, data = Symcap, FUN=mean)
XY<-merge(Latitude, Longitude, by="Reef.ID", all=T)
propDom=table(Symcap$Dom, Symcap$Reef.ID)
propDom=prop.table(propDom, margin = 2)
propDom <- as.data.frame.matrix(propDom)
props <- data.frame(t(propDom))
props$Reef.ID <- rownames(props)
XY<-merge(XY, props, by="Reef.ID", all=T)
reef.dists <- dist(cbind(XY$Longitude, XY$Latitude))
dom.dists <- dist(XY$C)
set.seed(12456)
mantel(dom.dists~reef.dists)
```


```{r, Raw_Values, message=FALSE, results='hide', echo=FALSE, include=FALSE, eval=F}
Latitude=aggregate(Latitude~Reef.ID, data=Symcap, FUN = mean)
Longitude=aggregate(Longitude~Reef.ID, data = Symcap, FUN=mean)
XY<-merge(Latitude, Longitude, by="Reef.ID", all=T)
newcoords <- LatLon2XY.centered(KBMap, XY$Latitude, XY$Longitude, zoom=13)
XY$X <- newcoords$newX
XY$Y <- newcoords$newY
XY <- subset(XY, Reef.ID!="37")

Symcap$Dominant <- ifelse(Symcap$Dom=="C", 0, 1)
dat <- aggregate(data.frame(prop=Symcap$Dominant), by=list(Reef.ID=Symcap$Reef.ID), FUN=mean, na.rm=T) #prop D/reef
mod <- glm(Dominant ~ newDepth + Reef.ID, data=Symcap)
mod2 <- glm(Dominant ~ newDepth * Reef.ID, data=Symcap)
library(lsmeans)
lsm <- lsmeans(mod, specs="Reef.ID")
lsm2 <- lsmeans(mod2, specs="Reef.ID")
res <- merge(dat, data.frame(summary(lsm))[,c(1:2)], by="Reef.ID")
res <- merge(res, data.frame(summary(lsm2))[,c(1:2)], by="Reef.ID")
colnames(res) <- c("Reef.ID", "raw.c", "c.adj", "c.adj.int")

XY2 <- merge(XY, res, by = "Reef.ID")
XY2$d.adj <- 1-XY2$c.adj
XY2$d.adj.int <- 1-XY2$c.adj.int
XY2$raw.d <- 1-XY2$raw.c

PlotOnStaticMap(KBMap, XY$Latitude, XY$Longitude)

rownames(XY2) <- XY2$Reef.ID
XY2 <- XY2[, -1]
XY2 <- na.omit(XY2)
apply(XY2, MARGIN=1, FUN=function(reef) {
  floating.pie(xpos = reef["X"], ypos = reef["Y"], 
               x=c(reef["raw.c"], reef["raw.d"]), radius = 7, 
               col = c("red", "blue"))
})
```


```{r, Adjusted_for_Depth_Interaction, message=FALSE, results='hide', eval=F}
Symcap$Dominant <- ifelse(Symcap$Dom=="C", 0, 1)
dat <- aggregate(data.frame(prop=Symcap$Dominant), by=list(Reef.ID=Symcap$Reef.ID), FUN=mean, na.rm=T) #prop D/reef
mod <- glm(Dominant ~ newDepth + Reef.ID, data=Symcap)
mod2 <- glm(Dominant ~ newDepth * Reef.ID, data=Symcap)
library(lsmeans)
lsm <- lsmeans(mod, specs="Reef.ID")
lsm2 <- lsmeans(mod2, specs="Reef.ID")
res <- merge(dat, data.frame(summary(lsm))[,c(1:2)], by="Reef.ID")
res <- merge(res, data.frame(summary(lsm2))[,c(1:2)], by="Reef.ID")
colnames(res) <- c("Reef.ID", "raw.c", "c.adj", "c.adj.int")

XY2 <- merge(XY, res, by = "Reef.ID")
XY2$d.adj <- 1-XY2$c.adj
XY2$d.adj.int <- 1-XY2$c.adj.int
XY2$raw.d <- 1-XY2$raw.c
```


# Color Morph and Dominant Symbiont per Bay Area
A multinomial logistic regression was performed on the interaction of color morph and dominant symbiont to discount the influence of depth on spatial distribution. 
```{r, message=FALSE, results='hide'}
Symcap$Dominant <- ifelse(Symcap$Dom=="C", 0, 1)
dat <- aggregate(data.frame(prop=Symcap$Dominant), by=list(Reef.ID=Symcap$Reef.ID), 
                 FUN=mean, na.rm=T) #prop D/reef
mod <- glm(Dominant ~ newDepth + Reef.ID, data=Symcap)
mod2 <- glm(Dominant ~ newDepth * Reef.ID, data=Symcap)
library(lsmeans)
lsm <- lsmeans(mod, specs="Reef.ID")
lsm2 <- lsmeans(mod2, specs="Reef.ID")
res <- merge(dat, data.frame(summary(lsm))[,c(1:2)], by="Reef.ID")
res <- merge(res, data.frame(summary(lsm2))[,c(1:2)], by="Reef.ID")
colnames(res) <- c("Reef.ID", "raw.c", "c.adj", "c.adj.int")

XY2 <- merge(XY, res, by = "Reef.ID")
XY2$d.adj <- 1-XY2$c.adj
XY2$d.adj.int <- 1-XY2$c.adj.int
XY2$raw.d <- 1-XY2$raw.c

manteltable = table(Symcap$Dom, Symcap$Color.Morph, Symcap$Reef.ID)
nc <- aggregate(interaction(Symcap$Color.Morph, Symcap$Dom), 
                by=list(Symcap$Reef.ID), FUN=table)
nc <- data.frame(Reef.ID=as.character(nc[,1]), prop.table(nc[,2], margin=1))
XY3 <- merge(XY2, nc, by="Reef.ID", all=T)

Symcap$ColDom <- interaction(Symcap$Color.Morph, Symcap$Dom)
model <- multinom(ColDom~newDepth+Reef.ID, Symcap)
means <- lsmeans(model, specs = "Reef.ID")
means
pp <- fitted(model)

newdat <- data.frame(Reef.ID = levels(Symcap$Reef.ID),
                   newDepth = mean(Symcap$newDepth, na.rm=T))
pred <- predict(model, newdata = newdat, "probs")
new <- data.frame(Reef.ID=as.character(newdat[,1]), pred)
XY4 <- merge(XY3, new, by="Reef.ID", all=T)
```


When considering the effect of bay area on the interaction of color morph and dominant symbiont, the proportion of brown colonies dominated by D increases as you move from the north to the south of the bay. The proportion increases almost 6x, yet the small number of colonies makes this non-compelling. 
```{r, ColDom~BayArea}
Type=table(Symcap$ColDom, Symcap$Bay.Area)
prop.table(Type, margin = 2)
chisq.test(Type)
```


```{r, Color~ReefType, echo=FALSE, include=FALSE}
results=table(Symcap$Color.Morph, Symcap$Reef.Type)
chisq.test(results)
```


## Figure 6: Color Morph and Dominant Symbiont at each Reef
```{r, results='hide', eval=F}
par(oma=c(3,3,0,0))
PlotOnStaticMap(KBMap, XY4$Latitude, XY4$Longitude)
axis(1, at = LatLon2XY.centered(KBMap, NA, c(-157.85, -157.81, -157.77))$newX, tcl=0.5, line = 0.5, col = "ghostwhite", col.ticks = "black", lwd = 1, outer = TRUE, labels = c("157.85°W", "157.81°W", "157.77°W"), padj = -2.5, cex.axis = 0.75)
axis(2, at = LatLon2XY.centered(KBMap, c(21.42, 21.46, 21.50), NA)$newY, tcl=0.5, line = 0.5, col = "ghostwhite", col.ticks = "black", lwd = 1, outer = TRUE, labels = c("21.42°N", "21.46°N", "21.50°N"), padj = 0.5, hadj = 0.60, las = 1, cex.axis = 0.75)

XY4 <- merge(XY3, new, by="Reef.ID", all=T)
XY4[XY4 == 0.000] <- 0.0000000001
rownames(XY4) <- XY4$Reef.ID
XY4 <- XY4[, -1]
XY4 <- na.omit(XY4)
apply(XY4, MARGIN=1, FUN=function(reef) {
  floating.pie(xpos = reef["X"], ypos = reef["Y"], 
               x=c(reef["Brown.C.y"], reef["Orange.C.y"], reef["Brown.D.y"], 
                   reef["Orange.D.y"]), radius = 7, 
               col = c("royalblue3", "cornflowerblue", "red", "rosybrown2"))
})

legend("bottomleft", legend=c("Brown-C", "Orange-C", "Brown-D", "Orange-D"), fill = c("royalblue3", "cornflowerblue", "red", "rosybrown2"))

par(new=T, mar=c(14,21,0,0))
HI <- readOGR("coast_n83.shp", "coast_n83") 
HI <- spTransform(HI, CRS("+proj=longlat +datum=NAD83")) 
plot(HI, xlim=c(-158.3, -157.6), ylim=c(21.35, 21.6), lwd=0.4, col="gray", bg="white")
rect(-157.87, 21.41, -157.75, 21.52)
box()
```

Adjusted values of Dominant Symbiont and Color Morph adjusted for the influence of depth.